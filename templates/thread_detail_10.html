<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>{{ thread.title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">

    <p><a href="{{ url_for('index') }}">← スレッド一覧に戻る</a></p>
    
    <h1>{{ thread.title }}</h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
            {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <p>
        作成者: <strong>{{ thread.author.username }}</strong>
        | 作成日時: {{ thread.created_at.strftime('%Y-%m-%d %H:%M') }}
    </p>

    <hr>

    <h2>投稿一覧</h2>
    <div class="post-list">
        {% for post in posts %}
            <div class="post-item">
                <div class="post-meta">
                    {{ loop.index }} : 
                    <strong>{{ post.author.username }}</strong> 
                    ({{ post.created_at.strftime('%Y-%m-%d %H:%M') }})

                    {# ★ いいねボタンエリア開始 ★ #}
                    <span style="margin-left: 15px;">
                        {% if current_user.is_authenticated %}
                            {# フォームを使ってPOST送信でいいねを切り替え #}
                            <form action="{{ url_for('toggle_like', post_id=post.id) }}" method="POST" style="display:inline;">
                                <button type="submit" style="background:none; border:none; cursor:pointer; color: #007bff; font-size: 1em;">
                                    {% if post.is_liked_by(current_user) %}
                                        ♥ いいね済
                                    {% else %}
                                        ♡ いいね
                                    {% endif %}
                                </button>
                            </form>
                        {% else %}
                            {# ログインしていない場合はテキストのみ表示 #}
                            <span style="color: #888;">♡ いいね</span>
                        {% endif %}
                        
                        {# いいね数カウント #}
                        <span style="font-weight:bold; margin-left: 3px;">
                            {{ post.likes.count() }}
                        </span>
                    </span>
                    {# ★ いいねボタンエリア終了 ★ #}

                    {# ★ 削除ボタンエリア（自分の投稿のみ表示） ★ #}
                    {% if current_user.is_authenticated and post.user_id == current_user.id %}
                        <span style="margin-left: 15px;">
                            <a href="{{ url_for('delete', id=post.id) }}" 
                               onclick="return confirm('本当に削除しますか？\n(スレッドの最初の投稿の場合、スレッドごと削除されます)')"
                               class="button" 
                               style="background-color: #dc3545; padding: 2px 8px; font-size: 0.8em;">削除</a>
                        </span>
                    {% endif %}
                    {# ★ 削除ボタンエリア終了 ★ #}

                </div>
                <div class="post-content">
                    {{ post.content | replace('\n', '<br>') | safe }}
                </div>
            </div>
        {% else %}
            <p>まだ投稿がありません。</p>
        {% endfor %}
    </div>

    {% if current_user.is_authenticated %}
        <div class="reply-section">
            <h3>返信する</h3>
            <form method="POST" action="{{ url_for('post_to_thread', thread_id=thread.id) }}">
                <div class="form-group">
                    <textarea name="content" required placeholder="ここに本文を入力してください"></textarea>
                </div>
                <button type="submit" class="button">書き込む</button>
            </form>
        </div>
    {% else %}
        <p style="margin-top: 30px;">
            返信するには <a href="{{ url_for('login') }}">ログイン</a> してください。
        </p>
    {% endif %}

    </div>
</body>
</html>